<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Use PNG images in LittlevGL | LittlevGL’s Blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Use PNG images in LittlevGL" />
<meta name="author" content="kisvegabor" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If you already used images in LittlevGL probably you used the Online image converter to convert an image to a C array and you compiled the C array into your code. However, since v5.2 LittlevGL has an image decoder interface which allows adding your own decoder functions to open and read any type of images. In this post, I will show you how to add and use the lodepng library to display PNG images in real time." />
<meta property="og:description" content="If you already used images in LittlevGL probably you used the Online image converter to convert an image to a C array and you compiled the C array into your code. However, since v5.2 LittlevGL has an image decoder interface which allows adding your own decoder functions to open and read any type of images. In this post, I will show you how to add and use the lodepng library to display PNG images in real time." />
<link rel="canonical" href="http://localhost:4000/2018-10-05/png_converter" />
<meta property="og:url" content="http://localhost:4000/2018-10-05/png_converter" />
<meta property="og:site_name" content="LittlevGL’s Blog" />
<meta property="og:image" content="http://localhost:4000/assets/png_converter/cover.png" />
<meta property="og:image:height" content="300" />
<meta property="og:image:width" content="300" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-05T00:00:00+02:00" />
<script type="application/ld+json">
{"datePublished":"2018-10-05T00:00:00+02:00","image":{"height":300,"width":300,"url":"http://localhost:4000/assets/png_converter/cover.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018-10-05/png_converter"},"@type":"BlogPosting","url":"http://localhost:4000/2018-10-05/png_converter","author":{"@type":"Person","name":"kisvegabor"},"headline":"Use PNG images in LittlevGL","description":"If you already used images in LittlevGL probably you used the Online image converter to convert an image to a C array and you compiled the C array into your code. However, since v5.2 LittlevGL has an image decoder interface which allows adding your own decoder functions to open and read any type of images. In this post, I will show you how to add and use the lodepng library to display PNG images in real time.","dateModified":"2018-10-05T00:00:00+02:00","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-78811084-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-78811084-3');
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">


    <!-- Cookie consent -->
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
    <script>
    window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#252e39"
        },
        "button": {
          "background": "#14a7d0"
        }
      }
    })});
    </script>

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="LittlevGL's Blog" />

  <!-- Google Analytics-->
  
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="https://blog.littlevgl.com">
      <h2 class="nav-title">LittlevGL's Blog</h2>
    </a>
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="https://littlevgl.com">Home</a></li>
      <li><a href="https://github.com/littlevgl/lvgl">GitHub</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post">
  <div class="post-info">
    <span>Written by</span>
    
        kisvegabor
    

    
      <br>
      <span>on&nbsp;</span><time datetime="2018-10-05 00:00:00 +0200">October 05, 2018</time>
    
  </div>

  <h1 class="post-title">Use PNG images in LittlevGL</h1>
  <div class="post-line"></div>

  <p>If you already used images in LittlevGL probably you used the <a href="https://littlevgl.com/image-to-c-array">Online image converter</a> to convert an image to a C array and you compiled the C array into your code. However, since v5.2 LittlevGL has an image decoder interface which allows adding your own decoder functions to open and read any type of images. In this post, I will show you how to add and use the <a href="https://github.com/lvandeve/lodepng">lodepng</a> library to display PNG images in real time.</p>

<h2 id="before-get-started">Before get started</h2>
<p>You need to know that opening PNG images in resource-limited embedded systems has advantages and disadvantages too. The main advantage is that PNG images have much smaller size than an uncompressed image. The disadvantage is that you need a big buffer to describe the whole image and in addition, the decoding needs some time. However, some considerations can be done. For example, keep the last image in the buffer, probably it will be required again or, if you have more RAM, keep the last 3 images buffered. This way you can save ROM because you store the images as PNG and you decode only those which are required. These all depend on your system and resources.</p>

<h2 id="start-littlevgl-in-a-pc-simulator">Start LittlevGL in a PC simulator</h2>
<p>It’s much faster and easier to work on PC compared to an embedded hardware. Therefore to help your development LittlevGL is ported to Windows, Linux and OSX too. If you didn’t set-up you PC simulator environment yet here is a great time to do it! Read this tutorial: https://littlevgl.com/pc-simulator</p>

<h2 id="add-and-test-the-png-decoder-library-with-a-file">Add and test the PNG decoder library with a file</h2>
<p>If you are not interested in the implementation details you can <strong>download</strong> a ready use <a href="https://github.com/littlevgl/blog/raw/master/assets/png_converter/png_decoder.zip">PNG decoder for LittelvGL</a>.</p>

<p>There are some PNG decoder libraries even for embedded systems. Basically, you can choose any of them because they all work similarly, however, there can be differences in speed and performance. For this tutorial, I’ve chosen the <a href="https://github.com/lvandeve/lodepng">lodepng</a> library. This library consists of only 2 files:</p>
<ul>
  <li>lodepng.cpp</li>
  <li>lodepng.h</li>
</ul>

<p>Download this two files and copy into your project next to your <em>main.c</em> file.  As you can see it’s a <strong>cpp</strong> file but don’t worry, you can rename it to <strong>lodepng.c</strong> if you want.</p>

<p>So to see how <em>lodepng</em> works we will decode a PNG image file into an array and use this array as an image source in LittlevGL.</p>

<p>I used the image below and copied into the project’s root folder.</p>

<p><img src="/assets/png_converter/png_decoder_test.png" alt="Example PNG image to decode with LittlevGL" /></p>

<p>For simplicity, I added all the code into <em>main.c</em>.</p>

<p>So the first thing is to include <em>lodepng</em>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "lodepng.h"
</span></code></pre></div></div>

<p>Now read the file and load it’s content to a buffer. It should be after <em>lv_init()</em> :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint32_t</span> <span class="n">error</span><span class="p">;</span>                 <span class="cm">/*For the return values of png decoder functions*/</span>

<span class="cm">/*Load the PNG file into buffer. It's still compressed (not decoded)*/</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">png_data</span><span class="p">;</span>      <span class="cm">/*Pointer to the loaded data. Same as the original file just loaded into the RAM*/</span>
<span class="kt">size_t</span> <span class="n">png_data_size</span><span class="p">;</span>          <span class="cm">/*Size of `png_data` in bytes*/</span>

<span class="n">error</span> <span class="o">=</span> <span class="n">lodepng_load_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">png_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_data_size</span><span class="p">,</span> <span class="s">"png_decoder_test.png"</span><span class="p">);</span>   <span class="cm">/*Load the file*/</span>
<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"error %u: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">lodepng_error_text</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now decode the PNG image from the buffer.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*Decode the PNG image*/</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">png_decoded</span><span class="p">;</span>    <span class="cm">/*Will be pointer to the decoded image*/</span>
<span class="kt">uint32_t</span> <span class="n">png_width</span><span class="p">;</span>             <span class="cm">/*Will be the width of the decoded image*/</span>
<span class="kt">uint32_t</span> <span class="n">png_height</span><span class="p">;</span>            <span class="cm">/*Will be the width of the decoded image*/</span>

<span class="cm">/*Decode the loaded image in ARGB8888 */</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">lodepng_decode32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">png_decoded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_height</span><span class="p">,</span> <span class="n">png_data</span><span class="p">,</span> <span class="n">png_data_size</span><span class="p">);</span>   

<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"error %u: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">lodepng_error_text</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The image is decompressed into <em>png_decoded</em>. We only need to set-up a LittlevGL image descriptor and create an image object.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*Initialize an image descriptor for LittlevGL with the decoded image*/</span>
<span class="n">lv_img_dsc_t</span> <span class="n">png_dsc</span><span class="p">;</span>
<span class="n">png_dsc</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">always_zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                          <span class="cm">/*It must be zero*/</span>
<span class="n">png_dsc</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">cf</span> <span class="o">=</span> <span class="n">LV_IMG_FORMAT_TRUE_COLOR_ALPHA</span><span class="p">;</span>      <span class="cm">/*Set the color format*/</span>
<span class="n">png_dsc</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">png_width</span><span class="p">;</span>
<span class="n">png_dsc</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">png_height</span><span class="p">;</span>
<span class="n">png_dsc</span><span class="p">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">png_width</span> <span class="o">*</span> <span class="n">png_height</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">png_dsc</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">png_decoded</span><span class="p">;</span>

<span class="cm">/*Create an image object and set the decoded PNG image as it's source*/</span>
<span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">img_obj</span> <span class="o">=</span> <span class="n">lv_img_create</span><span class="p">(</span><span class="n">lv_scr_act</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>     <span class="cm">/*Create the an image object in LittlevGL*/</span>
<span class="n">lv_img_set_src</span><span class="p">(</span><span class="n">img_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_dsc</span><span class="p">);</span>                          <span class="cm">/*Set the image source to the decoded PNG*/</span>
<span class="n">lv_obj_set_drag</span><span class="p">(</span><span class="n">img_obj</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>                             <span class="cm">/*Make to image dragable*/</span>

<span class="cm">/*Set a non-white background color for the scren to see the alpha is working on the image*/</span>
<span class="n">lv_style_scr</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">main_color</span> <span class="o">=</span> <span class="n">LV_COLOR_MAKE</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
</code></pre></div></div>

<p>After compile and run I got this:</p>

<p><img src="/assets/png_converter/png_decode_one.png" alt="PNG image decoded in LittlevGL with lodepng" /></p>

<h2 id="test-the-png-decoder-library-with-a-png-file-stored-in-rom">Test the PNG decoder library with a PNG file stored in ROM</h2>

<p>If you <strong>don’t have a file system</strong> on your device and you’d like to store the PNG image in ROM and decode it when you need it you can use the <a href="https://littlevgl.com/image-to-c-array">Online image converter</a> to get a C array from an uncompressed PNG file. Just upload the PNG image, select the<strong>Raw with alpha</strong> color format and <strong>C array</strong> output format. Here is <a href="/blog/png/png_decoder_test.c">the result file</a>. Copy this file in your project and modify the decoder code like below. You just need to remove the “load from file” section and use the data from the converted file.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LV_IMG_DECLARE</span><span class="p">(</span><span class="n">png_decoder_test</span><span class="p">);</span>   <span class="cm">/*Declare the C array*/</span>
<span class="kt">uint32_t</span> <span class="n">error</span><span class="p">;</span>                     <span class="cm">/*For the return values of png decoder functions*/</span>

<span class="cm">/*Decode the PNG image*/</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">png_decoded</span><span class="p">;</span>    <span class="cm">/*Will be pointer to the decoded image*/</span>
<span class="kt">uint32_t</span> <span class="n">png_width</span><span class="p">;</span>             <span class="cm">/*Will be the width of the decoded image*/</span>
<span class="kt">uint32_t</span> <span class="n">png_height</span><span class="p">;</span>            <span class="cm">/*Will be the width of the decoded image*/</span>

 <span class="cm">/*Decode the loaded image in ARGB8888 */</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">lodepng_decode32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">png_decoded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_height</span><span class="p">,</span> <span class="n">png_decoder_test</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">png_decoder_test</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>  

<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"error %u: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">lodepng_error_text</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*Initialize an image descriptor for LittlevGL with the decoded image*/</span>
<span class="p">...</span> <span class="n">from</span> <span class="n">here</span> <span class="n">the</span> <span class="n">same</span> <span class="n">as</span> <span class="n">above</span> <span class="p">..</span>
</code></pre></div></div>

<p>It resulted in the same image.</p>

<h2 id="test-the-png-decoders-speed-on-a-microcontroller">Test the PNG decoder’s speed on a microcontroller</h2>
<p>I tested the PNG decoder’s speed with an <a href="https://www.st.com/en/microcontrollers/stm32f429zi.html">STM32F429ZI</a> microcontroller which runs at 180MHz and has 2 MB flash and 256 kB RAM. The test image had <strong>100 x 65</strong> resolution. The decompression lasted for <strong>7 ms</strong>.  Note that the result is in ARGB8888 format which might be converted to the systems color format (e.g. RGB565). This conversion required 1 ms.</p>

<h2 id="connect-the-png-decoder-to-littlevgl">Connect the PNG decoder to LittlevGL</h2>
<p>LittlveGL requires 4 functions to decode your custom image formats:</p>
<ol>
  <li><strong>decoder info</strong>  used to get the most basic information about the image like it’s width, height and color format.</li>
  <li><strong>decoder open</strong>  can work in two ways:
    <ul>
      <li>Open and decode the whole image into a buffer and return with this buffer. (it will be used with PNG images)</li>
      <li>Only prepare the decoding and return with <code class="highlighter-rouge">NULL</code>. In this case <code class="highlighter-rouge">decoder read</code> will be called to read the relevant parts of the image line-by-line.</li>
    </ul>
  </li>
  <li><strong>decoder read line</strong> as described above it is called to read ONLY the required lines of the image. If the image decoder supports partial decompression it can save RAM and time.</li>
  <li><strong>decoder close</strong> free the used resources</li>
</ol>

<p>So let’s see how to implement these function to decode PNG images!</p>

<h2 id="decoder-info">Decoder info</h2>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Get info about a PNG image
 * @param src can be file name or pointer to a C array
 * @param header store the info here
 * @return LV_RES_OK: no error; LV_RES_INV: can't get the info
 */</span>
<span class="n">lv_res_t</span> <span class="nf">decoder_info</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="n">lv_img_header_t</span> <span class="o">*</span> <span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
     <span class="n">lv_img_src_t</span> <span class="n">src_type</span> <span class="o">=</span> <span class="n">lv_img_src_get_type</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>          <span class="cm">/*Get the source type*/</span>

     <span class="cm">/*If it's a PNG file...*/</span>
     <span class="k">if</span><span class="p">(</span><span class="n">src_type</span> <span class="o">==</span> <span class="n">LV_IMG_SRC_FILE</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">],</span> <span class="s">"png"</span><span class="p">))</span> <span class="p">{</span>              <span class="cm">/*Check the extension*/</span>

             <span class="cm">/* Read the width and height from the file. They have a constant location:
              * [16..23]: width
              * [24..27]: height
              */</span>
             <span class="kt">FILE</span><span class="o">*</span> <span class="n">file</span><span class="p">;</span>
             <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">"rb"</span> <span class="p">);</span>
             <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="k">return</span> <span class="n">LV_RES_INV</span><span class="p">;</span>
             <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
             <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
             <span class="n">fread</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
             <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

             <span class="cm">/*Save the data in the header*/</span>
             <span class="n">header</span><span class="o">-&gt;</span><span class="n">always_zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">header</span><span class="o">-&gt;</span><span class="n">cf</span> <span class="o">=</span> <span class="n">LV_IMG_FORMAT_RAW_ALPHA</span><span class="p">;</span>
             <span class="cm">/*The width and height are stored in Big endian format so convert them to little endian*/</span>
             <span class="n">header</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">lv_coord_t</span><span class="p">)</span> <span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span>  <span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
             <span class="n">header</span><span class="o">-&gt;</span><span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">lv_coord_t</span><span class="p">)</span> <span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span>  <span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

             <span class="k">return</span> <span class="n">LV_RES_OK</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
     <span class="cm">/*If it's a PNG file in a  C array...*/</span>
     <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">src_type</span> <span class="o">==</span> <span class="n">LV_IMG_SRC_VARIABLE</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">const</span> <span class="n">lv_img_dsc_t</span> <span class="o">*</span> <span class="n">img_dsc</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
         <span class="n">header</span><span class="o">-&gt;</span><span class="n">always_zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="n">header</span><span class="o">-&gt;</span><span class="n">cf</span> <span class="o">=</span> <span class="n">img_dsc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cf</span><span class="p">;</span>       <span class="cm">/*Save the color format*/</span>
         <span class="n">header</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">img_dsc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>         <span class="cm">/*Save the color width*/</span>
         <span class="n">header</span><span class="o">-&gt;</span><span class="n">h</span> <span class="o">=</span> <span class="n">img_dsc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">h</span><span class="p">;</span>         <span class="cm">/*Save the color height*/</span>
         <span class="k">return</span> <span class="n">LV_RES_OK</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">return</span> <span class="n">LV_RES_INV</span><span class="p">;</span>         <span class="cm">/*If didn't succeeded earlier then it's an error*/</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="decoder-open">Decoder open</h2>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">png_decoded</span><span class="p">;</span>    <span class="cm">/*Will be pointer to the decoded image*/</span>

<span class="cm">/**
 * Open a PNG image and return the decided image
 * @param src can be file name or pointer to a C array
 * @param style style of the image object (unused now but certain formats might use it)
 * @return pointer to the decoded image or  `LV_IMG_DECODER_OPEN_FAIL` if failed
 */</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="nf">decoder_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="n">lv_style_t</span> <span class="o">*</span> <span class="n">style</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">error</span><span class="p">;</span>                 <span class="cm">/*For the return values of PNG decoder functions*/</span>

    <span class="n">lv_img_src_t</span> <span class="n">src_type</span> <span class="o">=</span> <span class="n">lv_img_src_get_type</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>          <span class="cm">/*Get the source type*/</span>

    <span class="cm">/*If it's a PNG file...*/</span>
    <span class="k">if</span><span class="p">(</span><span class="n">src_type</span> <span class="o">==</span> <span class="n">LV_IMG_SRC_FILE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">],</span> <span class="s">"png"</span><span class="p">))</span> <span class="p">{</span>              <span class="cm">/*Check the extension*/</span>

            <span class="cm">/*Load the PNG file into buffer. It's still compressed (not decoded)*/</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">png_data</span><span class="p">;</span>      <span class="cm">/*Pointer to the loaded data. Same as the original file just loaded into the RAM*/</span>
            <span class="kt">size_t</span> <span class="n">png_data_size</span><span class="p">;</span>          <span class="cm">/*Size of `png_data` in bytes*/</span>

            <span class="n">error</span> <span class="o">=</span> <span class="n">lodepng_load_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">png_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_data_size</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>   <span class="cm">/*Load the file*/</span>
            <span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"error %u: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">lodepng_error_text</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
                <span class="k">return</span> <span class="n">LV_IMG_DECODER_OPEN_FAIL</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/*Decode the PNG image*/</span>
            <span class="kt">uint32_t</span> <span class="n">png_width</span><span class="p">;</span>             <span class="cm">/*Will be the width of the decoded image*/</span>
            <span class="kt">uint32_t</span> <span class="n">png_height</span><span class="p">;</span>            <span class="cm">/*Will be the width of the decoded image*/</span>

            <span class="cm">/*Decode the loaded image in ARGB8888 */</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">lodepng_decode32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">png_decoded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_height</span><span class="p">,</span> <span class="n">png_data</span><span class="p">,</span> <span class="n">png_data_size</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"error %u: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">lodepng_error_text</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
                <span class="k">return</span> <span class="n">LV_IMG_DECODER_OPEN_FAIL</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">png_decoded</span><span class="p">;</span>     <span class="cm">/*The image is fully decoded. Return with its pointer*/</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/*If it's a PNG file in a  C array...*/</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">src_type</span> <span class="o">==</span> <span class="n">LV_IMG_SRC_VARIABLE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">lv_img_dsc_t</span> <span class="o">*</span> <span class="n">img_dsc</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
        <span class="kt">uint32_t</span> <span class="n">png_width</span><span class="p">;</span>             <span class="cm">/*No used, just required by he decoder*/</span>
        <span class="kt">uint32_t</span> <span class="n">png_height</span><span class="p">;</span>            <span class="cm">/*No used, just required by he decoder*/</span>

        <span class="cm">/*Decode the image in ARGB8888 */</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">lodepng_decode32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">png_decoded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">png_height</span><span class="p">,</span> <span class="n">img_dsc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">img_dsc</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">LV_IMG_DECODER_OPEN_FAIL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">png_decoded</span><span class="p">;</span>     <span class="cm">/*Return with its pointer*/</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">LV_IMG_DECODER_OPEN_FAIL</span><span class="p">;</span>    <span class="cm">/*If not returned earlier then it failed*/</span>
<span class="p">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="cp">## Decoder close
</span><span class="cm">/**
 * Free the allocated resources
 */</span>
<span class="kt">void</span> <span class="n">decoder_close</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">png_decoded</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="register-the-decoder-functions-in-littlevgl">Register the decoder functions in LittlevGL</h2>
<p>And finally the created functions should be regitered in LittlevGL:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lv_img_decoder_set_custom</span><span class="p">(</span><span class="n">decoder_info</span><span class="p">,</span> <span class="n">decoder_open</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">decoder_close</span><span class="p">);</span>
</code></pre></div></div>

<p>After this, if you can set PNG images from file or C array as the source of <a href="https://docs.littlevgl.com/#Image">image object’s</a> of LittlevGL</p>

<h2 id="conclusion">Conclusion</h2>
<p>You just learned how to use the image decoder interface of LittlevGL to add a custom image format. It’s a powerful feature which enables you to use any type of images according to your needs. You can even convert your images to a unique format which exactly meet your needs.</p>



</div>

<div class="pagination">
  
    <a href="/2018-12-06/contributing" class="left arrow">&#8592;</a>
  
  
    <a href="/2018-10-01/release_v5_2" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>

<script>

window.onload = function () {
    var tags = [ "h1","h2","h3", "h4", "h5", "h6" ];
    var h;

    for(var i = 0; i < tags.length; i++) {
        h = document.getElementsByTagName(tags[i]);
            
        for(j = 0; j < h.length; j++) {
            var x = "<a href='#" + h[j].id + "' style='color:#353535'>" + h[j].innerHTML + "</a>";
            h[j].innerHTML = x; 
        }
    }
}
    
</script>

    </main>

    <footer>
  <span>
    &copy; <time datetime="2019-02-09 05:26:57 +0100">2019</time> Gabor Kiss-Vamosi. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer>

  </body>
</html>
