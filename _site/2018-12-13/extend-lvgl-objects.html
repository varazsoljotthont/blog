<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Extend the functionality of objects in LittlevGL | LittlevGL’s Blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Extend the functionality of objects in LittlevGL" />
<meta name="author" content="kisvegabor" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Although the Objects in LittlevGL have a lot of built-in features sometimes you might need something special. For example, draw something unique on an object or change its behavior. In this post, I will show you how to add extra functionality to the objects in LittlevGL. You will also learn how LittlevGL works under to hood" />
<meta property="og:description" content="Although the Objects in LittlevGL have a lot of built-in features sometimes you might need something special. For example, draw something unique on an object or change its behavior. In this post, I will show you how to add extra functionality to the objects in LittlevGL. You will also learn how LittlevGL works under to hood" />
<link rel="canonical" href="http://localhost:4000/2018-12-13/extend-lvgl-objects" />
<meta property="og:url" content="http://localhost:4000/2018-12-13/extend-lvgl-objects" />
<meta property="og:site_name" content="LittlevGL’s Blog" />
<meta property="og:image" content="http://localhost:4000/assets/extend_lvgl_objects/cover.png" />
<meta property="og:image:height" content="300" />
<meta property="og:image:width" content="300" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-12-13T00:00:00+01:00" />
<script type="application/ld+json">
{"datePublished":"2018-12-13T00:00:00+01:00","image":{"height":300,"width":300,"url":"http://localhost:4000/assets/extend_lvgl_objects/cover.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018-12-13/extend-lvgl-objects"},"@type":"BlogPosting","url":"http://localhost:4000/2018-12-13/extend-lvgl-objects","author":{"@type":"Person","name":"kisvegabor"},"headline":"Extend the functionality of objects in LittlevGL","description":"Although the Objects in LittlevGL have a lot of built-in features sometimes you might need something special. For example, draw something unique on an object or change its behavior. In this post, I will show you how to add extra functionality to the objects in LittlevGL. You will also learn how LittlevGL works under to hood","dateModified":"2018-12-13T00:00:00+01:00","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-78811084-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-78811084-3');
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">


    <!-- Cookie consent -->
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
    <script>
    window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#252e39"
        },
        "button": {
          "background": "#14a7d0"
        }
      }
    })});
    </script>

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="LittlevGL's Blog" />

  <!-- Google Analytics-->
  
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="https://blog.littlevgl.com">
      <h2 class="nav-title">LittlevGL's Blog</h2>
    </a>
    <ul>
      <li><a href="/">Posts</a></li>
      <li><a href="https://littlevgl.com">Home</a></li>
      <li><a href="https://github.com/littlevgl/lvgl">GitHub</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post">
  <div class="post-info">
    <span>Written by</span>
    
        kisvegabor
    

    
      <br>
      <span>on&nbsp;</span><time datetime="2018-12-13 00:00:00 +0100">December 13, 2018</time>
    
  </div>

  <h1 class="post-title">Extend the functionality of objects in LittlevGL</h1>
  <div class="post-line"></div>

  <p><strong>Although the <a href="https://docs.littlevgl.com/#Object-types">Objects in LittlevGL</a> have a lot of built-in features sometimes you might need something special. For example, draw something unique on an object or change its behavior. 
In this post, I will show you how to add extra functionality to the objects in LittlevGL. You will also learn how LittlevGL works under to hood</strong></p>

<h2 id="inheritance">Inheritance</h2>
<p>Maybe you already know about the inheritance among object types in LittlevGL. Don’t panic if don’t you can learn it now.</p>

<p>Although C doesn’t support classes and inheritance as C++ does with a few tricks and limitations something similar can be achieved. In LittlevGL inheritance means that a derived object knows all the features of its ancestor.</p>

<p>For example, a <a href="https://docs.littlevgl.com/#Button">Button</a> is inherited from the <a href="https://docs.littlevgl.com/#Container">Container</a>. The <em>Container</em> has the <em>Layout</em> feature so the <em>Button</em> also has this feature. The <em>Container</em> is inherited from the <a href="https://docs.littlevgl.com/#Base-object">Base object</a>. 
The <em>Base object</em> knows all the basic things like position and size. So the <em>Container</em> and the <em>Button</em> also have position and size attributes.</p>

<p><img src="/assets/extend_lvgl_objects/inheritance.jpg" alt="Inheritance example in LittlevGL" />
<em>Inheritance example in LittlevGL</em></p>

<p>Because the <em>Base object</em> is the ancestor of every object type (sometimes indirectly through other objects types) every object type has size, position, and similar basic attributes.</p>

<h2 id="extended-data">Extended data</h2>
<p>In LittlevGL every object type has a data structure (<code class="highlighter-rouge">struct</code>) which holds data for the objects. It is called <strong>extended data</strong>.</p>

<p>For example, in case, of a <em>Button</em> this structure stores the current state (pressed, released etc.) and the styles for each state.</p>

<p>To work with inheritance the ancestors should see the object in same way independently if something is derived from it or not. 
So <em>Container</em> shouldn’t care about if it’s really just a <em>Container</em> or a <em>Button</em>, the layout feature should work. 
To achieve it the extended data is declared like this:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*Example extended data of an ancestor */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">value1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">value2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ancestor_t</span><span class="p">;</span>


<span class="cm">/*Example extended data of a derived object*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">ancestor_t</span> <span class="n">ancestor</span><span class="p">;</span>      <span class="cm">/*Include the ancestors extend data first*/</span>
  <span class="kt">char</span> <span class="o">*</span> <span class="n">text</span><span class="p">;</span>              <span class="cm">/*Add new data*/</span>
<span class="p">}</span> <span class="n">derived_t</span><span class="p">;</span>

</code></pre></div></div>

<p>So the key is to add the ancestors extended data first. This way if the ancestor reads the extended data as <code class="highlighter-rouge">ancestor_t</code> is will see the correct type and if the derived reads it, it will see the <em>ancesor</em> + <em>derived data</em>.</p>

<h3 id="add-custom-extended-data-to-an-object-type">Add custom extended data to an object type</h3>

<p>Let’s see a silly but real life example. Store an integer temperature value in a button’s extended data:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*Custom extended data based on the Button*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">lv_btn_ext_t</span> <span class="n">btn</span><span class="p">;</span>       <span class="cm">/*The ancestor button structure*/</span>
    <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>               <span class="cm">/*New custom data*/</span>
<span class="p">}</span><span class="n">temp_btn_ext_t</span><span class="p">;</span>

<span class="cm">/**
 * Called when the button is clicked
 * @param btn pointer to a button
 * @return LV_RES_OK because the button is not deleted here
 */</span>
<span class="n">lv_res_t</span> <span class="nf">btn_click</span><span class="p">(</span><span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">btn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*Get the extended data*/</span>
    <span class="n">temp_btn_ext_t</span> <span class="o">*</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">lv_obj_get_ext_attr</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>

    <span class="cm">/*Do something with the temperature value*/</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Button temp: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">LV_RES_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">btn</span> <span class="o">=</span> <span class="n">lv_btn_create</span><span class="p">(</span><span class="n">lv_scr_act</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">lv_btn_set_action</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">LV_BTN_ACTION_CLICK</span><span class="p">,</span> <span class="n">btn_click</span><span class="p">);</span> <span class="cm">/*Assign an action function*/</span>
    <span class="n">lv_obj_allocate_ext_attr</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_btn_ext_t</span><span class="p">));</span>  <span class="cm">/*Re-alloacte the extended data*/</span>

    <span class="cm">/*Use the custom extended data*/</span>
    <span class="n">temp_btn_ext_t</span> <span class="o">*</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">lv_obj_get_ext_attr</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>That’s it. Now you know how to add any custom data an object.</p>

<h2 id="custom-functions">Custom functions</h2>

<p>In LittlevGL every object has two special functions:</p>
<ul>
  <li><strong>Design function</strong> defines how the object should look like</li>
  <li><strong>Signal function</strong> defines how the object should behave</li>
</ul>

<h3 id="design-function">Design function</h3>
<p>The design function of the objects are called automatically by the library when the object needs to be redrawn. A simple design function to draw a rectangle looks like this:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Example design function
 * @param obj pointer to the object to draw
 * @param mask only this area will be redrawn
 * @param mode see below
 * @return if mode == LV_DESIGN_COVER_CHK:
 *              true if the object fully covers the mask area
 *         else:
 *              always true  
 */</span>
<span class="n">bool</span> <span class="nf">example_design</span><span class="p">(</span><span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">obj</span><span class="p">,</span> 
                    <span class="k">const</span>  <span class="n">lv_area_t</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> 
                    <span class="n">lv_design_mode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_COVER_CHK</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Decide if the object's coordinates (obj-&gt;coords) 
         * are fully cover mask or not */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cover</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_DRAW_MAIN</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Draw the object. For example draw a rectangle. */</span>
        <span class="n">lv_style_t</span> <span class="o">*</span> <span class="n">style</span> <span class="o">=</span> <span class="n">lv_obj_get_style</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
        <span class="n">lv_draw_rect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">coords</span><span class="p">,</span> <span class="n">mask_p</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">lv_obj_get_opa_scale</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
    <span class="p">}</span> 
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_DRAW_POST</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* You can do here further drawings when all the 
         * children of this object are drawn.
         * For example, scroll bars of lv_page are drawn here to be on top*/</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>It might look a little bit complicated. But usually you don’t have to write a totally new design function, just extend the existing one.</p>

<p>Let’s continue the previous “button + temperature” example and display the stored temperature data on the button using a custom design function. For simplicity the text is not aligned vertically.</p>

<p><img src="/assets/extend_lvgl_objects/design1.png" alt="Extended design function adds custom text to a LittlevGL button" />
<em>Extended design function adds custom text to a LittlevGL button</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*Store the original button design function here*/</span>
<span class="k">static</span> <span class="n">lv_design_func_t</span> <span class="n">old_btn_design</span><span class="p">;</span>

<span class="n">bool</span> <span class="nf">new_btn_design</span><span class="p">(</span><span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span>  <span class="n">lv_area_t</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">lv_design_mode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_COVER_CHK</span><span class="p">)</span> <span class="p">{</span>
       <span class="cm">/*Use the original function for cover check*/</span>
       <span class="k">return</span> <span class="n">old_btn_design</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_DRAW_MAIN</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*Draw the original button first*/</span>
        <span class="n">old_btn_design</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

        <span class="cm">/*Draw a label*/</span>
        <span class="n">temp_btn_ext_t</span> <span class="o">*</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">lv_obj_get_ext_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"Temp</span><span class="se">\n</span><span class="s">%d"</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">);</span>
        <span class="n">lv_draw_label</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">coords</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lv_style_btn_rel</span><span class="p">,</span> <span class="n">lv_obj_get_opa_scale</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">LV_TXT_FLAG_CENTER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_DRAW_POST</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*Use the original function for post draw*/</span>
        <span class="n">old_btn_design</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_btn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">btn</span> <span class="o">=</span> <span class="n">lv_btn_create</span><span class="p">(</span><span class="n">lv_scr_act</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">old_btn_design</span> <span class="o">=</span> <span class="n">lv_obj_get_design_func</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="n">lv_obj_set_design_func</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">new_btn_design</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h4 id="animation-example">Animation example</h4>

<p>Now create a custom animation using some additional extended data and a new design function. The animation will change the button’s appearance to the pressed style and back when it is released.</p>

<p><img src="/assets/extend_lvgl_objects/btn_anim.gif" alt="Animated button with LittlevGL" />
<em>Animated button with LittlevGL</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*Store the original button design function here*/</span>
<span class="k">static</span> <span class="n">lv_design_func_t</span> <span class="n">old_btn_design</span><span class="p">;</span>

<span class="cm">/**
 * Called by the animation
 * @param btn pointer to a button to animate
 * @param value current value of animation
 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">btn_anim_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">btn</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Save the new value and refresh the object.
     * `anim_state` will be used in the design function*/</span>
    <span class="n">temp_btn_ext_t</span> <span class="o">*</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">lv_obj_get_ext_attr</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">anim_state</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">lv_obj_invalidate</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**
 * Called when the button is clicked
 * @param btn pointer to a button
 * @return LV_RES_OK because the button is not deleted here
 */</span>
<span class="n">lv_res_t</span> <span class="nf">btn_click</span><span class="p">(</span><span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">btn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*Start a play back animation */</span>
    <span class="n">lv_anim_t</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">btn</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lv_anim_fp_t</span><span class="p">)</span><span class="n">btn_anim_func</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">lv_anim_path_linear</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">end_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">act_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">playback_pause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">repeat_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lv_anim_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">LV_RES_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">new_btn_design</span><span class="p">(</span><span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span>  <span class="n">lv_area_t</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">lv_design_mode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_COVER_CHK</span><span class="p">)</span> <span class="p">{</span>
       <span class="cm">/*Use the original function for cover check*/</span>
       <span class="k">return</span> <span class="n">old_btn_design</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_DRAW_MAIN</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/*Draw a rectangle with the normal released style*/</span>
        <span class="n">lv_draw_rect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">coords</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> 
                     <span class="n">lv_btn_get_style</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">LV_BTN_STYLE_REL</span><span class="p">),</span> <span class="n">lv_obj_get_opa_scale</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>

        <span class="cm">/* Draw an other rectangle on top of the previous with pressed state but
         * set its opacity according to `anim_state`*/</span>
        <span class="n">temp_btn_ext_t</span> <span class="o">*</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">lv_obj_get_ext_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
        <span class="n">lv_style_t</span> <span class="n">style</span><span class="p">;</span>
        <span class="n">lv_style_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">style</span><span class="p">,</span> <span class="n">lv_btn_get_style</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">LV_BTN_STYLE_PR</span><span class="p">));</span>
        <span class="n">style</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">opa</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">anim_state</span><span class="p">;</span>
        <span class="n">lv_draw_rect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">coords</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">style</span><span class="p">,</span> <span class="n">lv_obj_get_opa_scale</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LV_DESIGN_DRAW_POST</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*Use the original function for post draw*/</span>
        <span class="n">old_btn_design</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_btn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">btn</span> <span class="o">=</span> <span class="n">lv_btn_create</span><span class="p">(</span><span class="n">lv_scr_act</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">lv_btn_set_action</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">LV_BTN_ACTION_CLICK</span><span class="p">,</span> <span class="n">btn_click</span><span class="p">);</span>
    <span class="n">lv_obj_allocate_ext_attr</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_btn_ext_t</span><span class="p">));</span>  <span class="cm">/*Re-alloacte the extended data*/</span>

    <span class="cm">/*Initialize the custom extended data*/</span>
    <span class="n">temp_btn_ext_t</span> <span class="o">*</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">lv_obj_get_ext_attr</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">anim_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/*Save the old design function and set the new one */</span>
    <span class="n">old_btn_design</span> <span class="o">=</span> <span class="n">lv_obj_get_design_func</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="n">lv_obj_set_design_func</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">new_btn_design</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="signal-function">Signal function</h3>

<p>The signal function is responsible for the behavior of the objects. When something happens with an object the library automatically sends a signal to the object to notify it. The signal is processed in the <em>signal function</em>  and the object can do something according to the event.</p>

<p>For example, when an object is released <code class="highlighter-rouge">LV_SIGNAL_RELEASED</code> is sent. In this case, a button calls the user-defined release action.</p>

<p>An other signal is <code class="highlighter-rouge">LV_SIGNAL_CORD_CHG</code>. For example, the <a href="https://docs.littlevgl.com/#Page">Page</a> object uses it to limit the scrolling of the scrollable area.</p>

<p><img src="/assets/extend_lvgl_objects/page_limit.gif" alt="The scrolling on a Page is limited" />
<em>The scrolling on a Page is limited</em></p>

<p>A signal function always calls its ancestor’s signal function first. This way an object type can inherit the behavior of its ancestors. For example, if a <em>Button</em>’s size has changed the layout needs to be recalculated by the <em>Container</em> (ancestor).</p>

<p>So let’s see what happens:</p>
<ol>
  <li>You call <code class="highlighter-rouge">lv_obj_set_size(btn, width, height)</code></li>
  <li><code class="highlighter-rouge">lv_obj_set_size</code> sends a <code class="highlighter-rouge">LV_SIGNAL_CORD_CHG</code> to the <em>Button</em></li>
  <li>In the <em>Button</em>’s signal function its ancestor’s (<em>Container</em>) signal function is called</li>
  <li>In the <em>Container</em>’s signal function the layout is recalculated i. e. the children are repositioned according to the new size.</li>
  <li>Finally, the button processes the signal, however. it has nothing to do with <code class="highlighter-rouge">LV_SIGNAL_CORD_CHG</code>.</li>
</ol>

<p>So by inheriting the <em>Button</em> from the <em>Container</em>, all the <em>Container</em> functionalities can be used by the <em>Button</em>.</p>

<h4 id="position-limitation-with-a-custom-signal-function">Position limitation with a custom signal function</h4>

<p>I will show you an example, how to create a signal function which:</p>
<ul>
  <li>Doesn’t let a button to be dragged out of its parent</li>
  <li>Enables only horizontal dragging</li>
  <li>Animates the button to the middle on release</li>
</ul>

<p>Without the new signal function it behaves like:</p>

<p><img src="/assets/extend_lvgl_objects/knob_before.gif" alt="Position limit still not applied" />
<em>Position limit still not applied</em></p>

<p>But with the new signal function:
<img src="/assets/extend_lvgl_objects/knob.gif" alt="Limit the position with signal function and add animation" />
<em>Limit the position with signal function and add animation</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">lv_signal_func_t</span> <span class="n">old_btn_signal</span><span class="p">;</span>     <span class="cm">/*Store the old signal function*/</span>
<span class="k">static</span> <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">info_label</span><span class="p">;</span>               <span class="cm">/*A label for the demo*/</span>

<span class="cm">/**
 * The new Signal function
 * @param btn pointer to the button object
 * @param sign a signal type from `lv_signal_t` enum
 * @param param pointer to a signal specific variable
 * @return LV_RES_OK: the object is not deleted in the function; LV_RES_INV: the object is deleted
 */</span>
<span class="k">static</span> <span class="n">lv_res_t</span> <span class="nf">new_btn_signal</span><span class="p">(</span><span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">btn</span><span class="p">,</span> <span class="n">lv_signal_t</span> <span class="n">sign</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">lv_res_t</span> <span class="n">res</span><span class="p">;</span>

    <span class="cm">/* MANDAORY: Include the ancient signal function */</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">old_btn_signal</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">LV_RES_OK</span><span class="p">)</span> <span class="k">return</span> <span class="n">res</span><span class="p">;</span>

    <span class="cm">/*Limit the horizontal movement if the coordinates are changed*/</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sign</span> <span class="o">==</span> <span class="n">LV_SIGNAL_CORD_CHG</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">lv_coord_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lv_obj_get_x</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
        <span class="n">lv_coord_t</span> <span class="n">w</span> <span class="o">=</span> <span class="n">lv_obj_get_width</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
        <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">lv_obj_get_parent</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
        <span class="n">lv_coord_t</span> <span class="n">parent_w</span> <span class="o">=</span> <span class="n">lv_obj_get_width</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">parent_w</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="n">parent_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">;</span>

        <span class="cm">/*Align vertically to the middle and use the limited x coordinate*/</span>
        <span class="n">lv_obj_align</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">LV_ALIGN_IN_LEFT_MID</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*If the knob is released ... */</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sign</span> <span class="o">==</span> <span class="n">LV_SIGNAL_RELEASED</span> <span class="o">||</span> <span class="n">sign</span> <span class="o">==</span> <span class="n">LV_SIGNAL_PRESS_LOST</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lv_coord_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lv_obj_get_x</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
        <span class="n">lv_coord_t</span> <span class="n">w</span> <span class="o">=</span> <span class="n">lv_obj_get_width</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
        <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">lv_obj_get_parent</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
        <span class="n">lv_coord_t</span> <span class="n">parent_w</span> <span class="o">=</span> <span class="n">lv_obj_get_width</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
  
        <span class="cm">/* The Click action is not called if the button was dragged.
         * So call it manually*/</span>
        <span class="n">lv_action_t</span> <span class="n">click_action</span> <span class="o">=</span> <span class="n">lv_btn_get_action</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">LV_BTN_ACTION_CLICK</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">click_action</span><span class="p">)</span> <span class="n">click_action</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>

        <span class="cm">/*Animate the knob back to the middle*/</span>
        <span class="n">lv_anim_t</span> <span class="n">a</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">btn</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">parent_w</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lv_anim_fp_t</span><span class="p">)</span><span class="n">lv_obj_set_x</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">lv_anim_path_linear</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">end_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">act_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">playback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">playback_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">repeat_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">lv_anim_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when the btn is released */</span>
<span class="k">static</span> <span class="n">lv_res_t</span> <span class="nf">btn_click</span><span class="p">(</span><span class="n">lv_obj_t</span><span class="o">*</span> <span class="n">btn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">lv_coord_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lv_obj_get_x</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">lv_obj_get_parent</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>
    <span class="n">lv_coord_t</span> <span class="n">parent_w</span> <span class="o">=</span> <span class="n">lv_obj_get_width</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

    <span class="cm">/*Determine the side and update the info label*/</span>
    <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">parent_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="n">lv_label_set_text</span><span class="p">(</span><span class="n">info_label</span><span class="p">,</span> <span class="s">"Left"</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">lv_label_set_text</span><span class="p">(</span><span class="n">info_label</span><span class="p">,</span> <span class="s">"Right"</span><span class="p">);</span>

    <span class="n">lv_obj_align</span><span class="p">(</span><span class="n">info_label</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">LV_ALIGN_OUT_BOTTOM_MID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">LV_RES_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_knob</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*Create a parent (gray rectangle)*/</span>
    <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">lv_obj_create</span><span class="p">(</span><span class="n">lv_scr_act</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">lv_obj_set_size</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
    <span class="n">lv_obj_set_style</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lv_style_pretty</span><span class="p">);</span>

    <span class="cm">/*Create a square rectangle button*/</span>
    <span class="n">lv_obj_t</span> <span class="o">*</span> <span class="n">btn</span> <span class="o">=</span> <span class="n">lv_btn_create</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">old_btn_signal</span> <span class="o">=</span> <span class="n">lv_obj_get_signal_func</span><span class="p">(</span><span class="n">btn</span><span class="p">);</span>       <span class="cm">/*Save to old signal function*/</span>
    <span class="n">lv_obj_set_signal_func</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">new_btn_signal</span><span class="p">);</span>        <span class="cm">/*Set a new signal function*/</span>
    <span class="n">lv_btn_set_action</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">LV_BTN_ACTION_CLICK</span><span class="p">,</span> <span class="n">btn_click</span><span class="p">);</span> <span class="cm">/*Set an action*/</span>
    <span class="n">lv_obj_set_drag</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>                         <span class="cm">/*Enable dragging*/</span>
    <span class="n">lv_obj_set_size</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>                       <span class="cm">/*Set the size*/</span>
    <span class="n">lv_obj_align</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">LV_ALIGN_CENTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>   <span class="cm">/*Align to the center of the parent*/</span>
    <span class="n">lv_obj_set_protect</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span> <span class="n">LV_PROTECT_PRESS_LOST</span><span class="p">);</span>     <span class="cm">/*To prevent press lost on fast drags*/</span>
 
    <span class="cm">/*Create an info label for the demo*/</span>
    <span class="n">info_label</span> <span class="o">=</span> <span class="n">lv_label_create</span><span class="p">(</span><span class="n">lv_scr_act</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">lv_label_set_text</span><span class="p">(</span><span class="n">info_label</span><span class="p">,</span> <span class="s">"Drag the knob"</span><span class="p">);</span>
    <span class="n">lv_obj_align</span><span class="p">(</span><span class="n">info_label</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">LV_ALIGN_OUT_BOTTOM_MID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div></div>

<h2 id="summary">Summary</h2>
<p>You have just learnt the three most important internal mechanisms of LittlevGL:</p>
<ul>
  <li>Extended data</li>
  <li>Design function</li>
  <li>Signal Function</li>
</ul>

<p>Use them them customise the exiting objects according to your needs!</p>



</div>

<div class="pagination">
  
    <a href="/2018-12-26/references" class="left arrow">&#8592;</a>
  
  
    <a href="/2018-12-06/contributing" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>

<script>

window.onload = function () {
    var tags = [ "h1","h2","h3", "h4", "h5", "h6" ];
    var h;

    for(var i = 0; i < tags.length; i++) {
        h = document.getElementsByTagName(tags[i]);
            
        for(j = 0; j < h.length; j++) {
            var x = "<a href='#" + h[j].id + "' style='color:#353535'>" + h[j].innerHTML + "</a>";
            h[j].innerHTML = x; 
        }
    }
}
    
</script>

    </main>

    <footer>
  <span>
    &copy; <time datetime="2019-02-09 05:26:57 +0100">2019</time> Gabor Kiss-Vamosi. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer>

  </body>
</html>
